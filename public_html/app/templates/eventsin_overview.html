<script>
_.defer(function (caller) {

	//===== Chart =====//
	var sin = [], cos = [];
	for (var i = 0; i < 21; i += 0.5) {
		sin.push([i, Math.sin(i)]);
		cos.push([i, Math.cos(i)]);
	}
	var plot = $.plot($(".chart"),
			[
				{ data:sin, label:"sin(x)"},
				{ data:cos, label:"cos(x)" }
			], {
				series:{
					lines:{ show:true },
					points:{ show:true }
				},
				grid:{ hoverable:true, clickable:true },
				yaxis:{ min:-1.1, max:1.1 },
				xaxis:{ min:0, max:20 }
			});

	var previousPoint = null;
	$(".chart").bind("plothover", function (event, pos, item) {
		$("#x").text(pos.x.toFixed(2));
		$("#y").text(pos.y.toFixed(2));

		if ($(".chart").length > 0) {
			if (item) {
				if (previousPoint != item.dataIndex) {
					previousPoint = item.dataIndex;

					$("#tooltip").remove();
					var x = item.datapoint[0].toFixed(2),
							y = item.datapoint[1].toFixed(2);

					showTooltip(item.pageX, item.pageY,
							item.series.label + " of " + x + " = " + y);
				}
			}
			else {
				$("#tooltip").remove();
				previousPoint = null;
			}
		}
	});

	//===== Chart Auto Update =====//
	// we use an inline data source in the example, usually data would
	// be fetched from a server
	var data = [], totalPoints = 200;

	function getRandomData() {
		if (data.length > 0)
			data = data.slice(1);

		// do a random walk
		while (data.length < totalPoints) {
			var prev = data.length > 0 ? data[data.length - 1] : 50;
			var y = prev + Math.random() * 10 - 5;
			if (y < 0)
				y = 0;
			if (y > 100)
				y = 100;
			data.push(y);
		}

		// zip the generated y values with the x values
		var res = [];
		for (var i = 0; i < data.length; ++i)
			res.push([i, data[i]])
		return res;
	}

	// setup control widget
	var updateInterval = 1000;
	$("#updateInterval").val(updateInterval).change(function () {
		var v = $(this).val();
		if (v && !isNaN(+v)) {
			updateInterval = +v;
			if (updateInterval < 1)
				updateInterval = 1;
			if (updateInterval > 2000)
				updateInterval = 2000;
			$(this).val("" + updateInterval);
		}
	});

	// setup plot
	var options = {
		yaxis:{ min:0, max:100 },
		xaxis:{ min:0, max:100 },
		colors:["#afd8f8"],
		series:{
			lines:{
				lineWidth:2,
				fill:true,
				fillColor:{ colors:[
					{ opacity:0.6 },
					{ opacity:0.2 }
				] },
				//"#dcecf9"
				steps:false

			}
		}
	};
	var plot = $.plot($(".autoUpdate"), [ getRandomData() ], options);

	function update() {
		plot.setData([ getRandomData() ]);
		// since the axes don't change, we don't need to call plot.setupGrid()
		plot.draw();

		setTimeout(update, updateInterval);
	}

	update();

	//===== Bar Chart =====//
	var d1 = [];
	for (var i = 0; i <= 12; i += 1)
		d1.push([i, parseInt(Math.random() * 20)]);

	var d2 = [];
	for (var i = 0; i <= 12; i += 1)
		d2.push([i, parseInt(Math.random() * 20)]);

	var d3 = [];
	for (var i = 0; i <= 12; i += 1)
		d3.push([i, parseInt(Math.random() * 20)]);

	var ds = new Array();

	ds.push({
		data:d1,
		bars:{
			show:true,
			barWidth:0.2,
			order:1,
		}
	});
	ds.push({
		data:d2,
		bars:{
			show:true,
			barWidth:0.2,
			order:2
		}
	});
	ds.push({
		data:d3,
		bars:{
			show:true,
			barWidth:0.2,
			order:3
		}
	});

	//Display graph
	$.plot($("#vBar"), ds, {
		grid:{
			hoverable:true
		},
		legend:true
	});

	//add tooltip event
	$("#vBar").bind("plothover", function (event, pos, item) {
		if (item) {
			if (previousPoint != item.datapoint) {
				previousPoint = item.datapoint;

				//delete de prГ©cГ©dente tooltip
				$('.tooltip').remove();

				var x = item.datapoint[0];

				//All the bars concerning a same x value must display a tooltip with this value and not the shifted value
				if (item.series.bars.order) {
					for (var i = 0; i < item.series.data.length; i++) {
						if (item.series.data[i][3] == item.datapoint[0])
							x = item.series.data[i][0];
					}
				}

				var y = item.datapoint[1];

				showTooltip(item.pageX + 5, item.pageY + 5, x + " = " + y);

			}
		}
		else {
			$('.tooltip').remove();
			previousPoint = null;
		}
	});

	//===== Pie Chart =====//
	var pdata = [];
	var series = Math.floor(Math.random() * 10) + 1;
	for (var i = 0; i < series; i++) {
		pdata[i] = { label:"Series" + (i + 1), pdata:Math.floor(Math.random() * 100) + 1 }
	}

	$.plot($("#pie"), pdata,
			{
				series:{
					pie:{
						show:true,
						label:{
							show:false,
							formatter:function (label, series) {
								return '<div style="font-size:11px;text-align:center;padding:4px;color:white;">' + label + '<br/>' + Math.round(series.percent) + '%</div>';
							},
							threshold:0.1
						}
					}
				},
				legend:{
					show:true,
					noColumns:1, // number of colums in legend table
					labelFormatter:null, // fn: string -> string
					labelBoxBorderColor:"#000", // border color for the little label boxes
					container:null, // container (as jQuery object) to put legend in, null means default on top of graph
					position:"ne", // position of default legend container within plot
					margin:[5, 10], // distance from grid edge to default legend container within plot
					backgroundColor:"#efefef", // null means auto-detect
					backgroundOpacity:1 // set to 0 to avoid background
				},
				grid:{
					hoverable:true,
					clickable:true
				}
			});

	$("#interactive").bind("plothover", pieHover);
	$("#interactive").bind("plotclick", pieClick);

	//===== Hbar Chart =====//
	//Display horizontal graph
	var d1_h = [];
	for (var i = 0; i <= 4; i += 1)
		d1_h.push([parseInt(Math.random() * 30), i ]);

	var d2_h = [];
	for (var i = 0; i <= 4; i += 1)
		d2_h.push([parseInt(Math.random() * 30), i ]);

	var d3_h = [];
	for (var i = 0; i <= 4; i += 1)
		d3_h.push([ parseInt(Math.random() * 30), i]);

	var ds_h = new Array();
	ds_h.push({
		data:d1_h,
		bars:{
			horizontal:true,
			show:true,
			barWidth:0.2,
			order:1,
		}
	});
	ds_h.push({
		data:d2_h,
		bars:{
			horizontal:true,
			show:true,
			barWidth:0.2,
			order:2
		}
	});
	ds_h.push({
		data:d3_h,
		bars:{
			horizontal:true,
			show:true,
			barWidth:0.2,
			order:3
		}
	});

	$.plot($("#hBar"), ds_h, {
		grid:{
			hoverable:true
		}
	});

	//add tooltip event
	$("#hBar").bind("plothover", function (event, pos, item) {
		if (item) {
			if (previousPoint != item.datapoint) {
				previousPoint = item.datapoint;

				//delete de prГ©cГ©dente tooltip
				$('.tooltip').remove();

				var x = item.datapoint[0];

				//All the bars concerning a same x value must display a tooltip with this value and not the shifted value
				if (item.series.bars.order) {
					for (var i = 0; i < item.series.data.length; i++) {
						if (item.series.data[i][3] == item.datapoint[0])
							x = item.series.data[i][0];
					}
				}

				var y = item.datapoint[1];

				showTooltip(item.pageX + 5, item.pageY + 5, x + " = " + y);

			}
		}
		else {
			$('.tooltip').remove();
			previousPoint = null;
		}

	});

}, this);

function showTooltip(x, y, contents) {
	$('<div id="tooltip" class="tooltip">' + contents + '</div>').css({
		position:'absolute',
		display:'none',
		top:y + 5,
		left:x + 5,
		border:'1px solid #000',
		padding:'2px 8px',
		'z-index':'9999',
		'background-color':'#202020',
		'color':'#fff',
		'font-size':'11px',
		opacity:0.85,
		'border-radius':'2px',
		'-webkit-border-radius':'2px',
		'-moz-border-radius':'2px'
	}).appendTo("body").fadeIn(200);
}

function pieHover(event, pos, obj) {
	if (!obj)
		return;
	percent = parseFloat(obj.series.percent).toFixed(2);
	$("#hover").html('<span style="font-weight: bold; color: ' + obj.series.color + '">' + obj.series.label + ' (' + percent + '%)</span>');
}
function pieClick(event, pos, obj) {
	if (!obj)
		return;
	percent = parseFloat(obj.series.percent).toFixed(2);
	alert('' + obj.series.label + ': ' + percent + '%');
}

</script>

<div class="title"><h5>Graphics and charts</h5></div>

<!-- Charts -->
<div class="widget first">
	<div class="head"><h5 class="iGraph">Charts</h5></div>
	<div class="body">
		<div class="chart"></div>
	</div>
</div>

<!-- Lines with fill -->
<div class="widget">
	<div class="head"><h5 class="iGraph">Charts</h5></div>
	<div class="body">
		<div class="autoUpdate"></div>
	</div>
</div>

<!-- Bars -->
<div class="widget">
	<div class="head"><h5 class="iStats">Bars</h5></div>
	<div class="body">
		<div class="bars" id="vBar"></div>
	</div>
</div>

<div class="fluid">
	<div class="span6">
		<div class="widget"><!-- Pie chart 1 -->
			<div class="head"><h5 class="iChart8">Pie charts</h5></div>
			<div class="body">
				<div id="hBar" class="pieWidget"></div>
			</div>
		</div>
	</div>

	<div class="span6">
		<div class="widget"><!-- Pie chart 2 -->
			<div class="head"><h5 class="iChart8">Pie charts</h5></div>
			<div class="body">
				<div id="pie" class="pieWidget"></div>
			</div>
		</div>
	</div>
</div>
